<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Scout</title>
    <style>
        body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
        h1 { color: #fff; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        button { 
            width: 100%; padding: 20px; margin: 10px 0; 
            background: #222; color: #0f0; border: 2px solid #0f0; 
            font-weight: bold; font-family: monospace; cursor: pointer;
        }
        button:active { background: #0f0; color: #000; }
        #log { margin-top: 20px; white-space: pre-wrap; font-size: 13px; line-height: 1.5; }
        .success { color: #0f0; }
        .error { color: #f44; }
        .info { color: #4af; }
    </style>
</head>
<body>

    <h1>KICKR Diagnostic Scout</h1>
    
    <p>1. Ensure KICKR is plugged in.<br>
       2. Ensure no other apps (Zwift, Wahoo) are open.<br>
       3. Tap the button below.</p>

    <button id="scanButton">SCAN FOR ALL DEVICES</button>
    <button id="clearButton" style="border-color: #666; color: #666;">CLEAR LOG</button>

    <div id="log">--- Ready to Scan ---</div>

    <script>
        const logEl = document.getElementById('log');

        function print(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.innerHTML = `> ${msg}\n`;
            logEl.appendChild(span);
            window.scrollTo(0, document.body.scrollHeight);
        }

        document.getElementById('clearButton').onclick = () => logEl.innerHTML = "";

        document.getElementById('scanButton').onclick = async () => {
            print("Requesting Bluetooth device list...", "info");
            
            try {
                // This is the most permissive scan possible
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [
                        '00001818-0000-1000-8000-00805f9b34fb', // Cycling Power
                        '00001816-0000-1000-8000-00805f9b34fb'  // Cycling Speed & Cadence
                    ]
                });

                print(`FOUND: ${device.name || "Unnamed Device"}`, "success");
                print(`ID: ${device.id}`, "info");

                device.addEventListener('gattserverdisconnected', () => {
                    print("Device disconnected.", "error");
                });

                print("Attempting to probe GATT Server...", "info");
                const server = await device.gatt.connect();
                print("GATT Connected.", "success");

                print("Scanning for primary services...", "info");
                const services = await server.getPrimaryServices();
                
                print(`Found ${services.length} services:`, "info");
                services.forEach(s => {
                    print(` - Service UUID: ${s.uuid}`);
                });

                if (services.some(s => s.uuid.includes('1818'))) {
                    print("CONFIRMED: This device supports KICKR Power control.", "success");
                }
                if (services.some(s => s.uuid.includes('1816'))) {
                    print("CONFIRMED: This device supports Cadence sensing.", "success");
                }

            } catch (err) {
                if (err.name === 'NotFoundError') {
                    print("Scan cancelled or no devices found.", "error");
                } else {
                    print(`ERROR: ${err.message}`, "error");
                }
            }
        };
    </script>
</body>
</html>