<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatula2 - GitHub Dynamic</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        .box { border: 3px solid #000; padding: 20px; border-radius: 12px; margin-bottom: 20px; background: #fff; }
        button { width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold; background: #e0e0e0; border-radius: 10px; }
        select { width: 100%; padding: 15px; font-size: 1.2rem; margin-bottom: 15px; border-radius: 8px; }
        #rawContent { background: #eee; padding: 15px; font-family: monospace; white-space: pre-wrap; margin-top: 10px; border-left: 5px solid #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 12px; text-align: left; }
        th { background: #f0f0f0; }
        .status-msg { font-weight: bold; color: #007bff; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>Spatula2 (GitHub Mode)</h1>

    <div class="box">
        <div id="scanStatus" class="status-msg" role="status">Initializing...</div>
        <label for="fileSelect"><strong>Available Workouts:</strong></label>
        <select id="fileSelect">
            <option value="">-- Scanning GitHub --</option>
        </select>
        <button id="readButton">Read and Interpret</button>
    </div>

    <div id="interpretation" class="box" style="display:none;">
        <h3>Interpretation</h3>
        <div id="rawContent"></div>
        <table id="resultTable">
            <thead>
                <tr><th>Step</th><th>Watts</th><th>Duration</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // CONFIGURATION: Set these to match your GitHub
        const GITHUB_USER = 'Chessel85'; // e.g., 'johndoe'
        const GITHUB_REPO = 'WahooKickrServer'; // e.g., 'kickr-app'
        
        const select = document.getElementById('fileSelect');
        const status = document.getElementById('scanStatus');

        // 1. SCAN GITHUB FOR TS FILES
        async function scanFiles() {
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`;
            try {
                const response = await fetch(url);
                const files = await response.ok ? await response.json() : [];
                
                // Filter files that start with TS and end with .txt
                const tsFiles = files.filter(f => f.name.startsWith('TS') && f.name.endsWith('.txt'));
                
                select.innerHTML = ''; // Clear loading msg
                if (tsFiles.length === 0) {
                    status.textContent = "No TS*.txt files found in GitHub repo.";
                    select.innerHTML = '<option>No files found</option>';
                    return;
                }

                tsFiles.forEach(file => {
                    let opt = document.createElement('option');
                    opt.value = file.name;
                    opt.textContent = file.name;
                    select.appendChild(opt);
                });
                status.textContent = `Found ${tsFiles.length} workout files.`;
            } catch (e) {
                status.textContent = "Error scanning GitHub: " + e.message;
            }
        }

        // 2. READ AND PARSE
        document.getElementById('readButton').addEventListener('click', async () => {
            const fileName = select.value;
            if (!fileName) return;

            try {
                // Use cache: "no-store" so you can push updates to GitHub and see them quickly
                const response = await fetch(fileName, { cache: "no-store" });
                const text = await response.text();
                
                document.getElementById('rawContent').textContent = text;
                const tableBody = document.querySelector('#resultTable tbody');
                tableBody.innerHTML = '';

                // PARSER LOGIC
                const lines = text.split('\n');
                let parsedQueue = [];
                let loopItems = [];
                let inLoop = false;

                lines.forEach(line => {
                    const clean = line.trim();
                    if (!clean || clean.startsWith('#') || clean.toLowerCase().startsWith('name:')) return;
                    if (clean === 'StartLoop') { inLoop = true; return; }
                    if (clean === 'EndLoop') { inLoop = false; parsedQueue = parsedQueue.concat(loopItems); return; }

                    const parts = clean.split(',');
                    if (parts.length === 2) {
                        const w = parseInt(parts[0]);
                        const d = parseInt(parts[1]);
                        if (!isNaN(w) && !isNaN(d)) {
                            const item = { w, d };
                            if (inLoop) loopItems.push(item);
                            else parsedQueue.push(item);
                        }
                    }
                });

                parsedQueue.forEach((seg, i) => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = i + 1;
                    row.insertCell(1).textContent = seg.w + "W";
                    row.insertCell(2).textContent = seg.d + " mins";
                });

                document.getElementById('interpretation').style.display = 'block';

            } catch (e) {
                alert("Error reading file: " + e.message);
            }
        });

        // Run scan on load
        scanFiles();
    </script>
</body>
</html>