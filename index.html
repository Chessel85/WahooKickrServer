<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR - Dundee</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <p style="font-size: 0.8em; color: gray;">Version: Dundee</p>
    
    <button id="connectButton">Connect & Hunt Char</button>
    <p id="status">Status: Disconnected</p>
    <p id="currentPower">Current: -- W</p>

    <div id="debugLog" style="background: #000; color: #0f0; border: 1px solid #333; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 11px; height: 350px; overflow-y: scroll;">
        [Dundee] System Initialized.<br>
    </div>

    <script>
const log = (msg) => {
    const now = new Date();
    const timestamp = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
    document.getElementById('debugLog').innerHTML += `[${timestamp}] ${msg}<br>`;
    document.getElementById('debugLog').scrollTop = document.getElementById('debugLog').scrollHeight;
};

const WAHOO_CHAR_UUID = "a026e005-0a7d-4ab3-97fa-f1500f9feb8b";
const POWER_CHAR_UUID = "00002a63-0000-1000-8000-00805f9b34fb";

// The 4 Services discovered by Edinburgh
const KNOWN_SERVICES = [
    'a026ee01-0a7d-4ab3-97fa-f1500f9feb8b',
    '00001818-0000-1000-8000-00805f9b34fb',
    '0000180a-0000-1000-8000-00805f9b34fb',
    '0000180f-0000-1000-8000-00805f9b34fb'
];

let controlChar = null;

document.getElementById('connectButton').addEventListener('click', async () => {
    try {
        log("Requesting Device...");
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: KNOWN_SERVICES
        });

        log("Connecting to GATT...");
        const server = await device.gatt.connect();
        
        // PAUSE 1: Stabilization (Matching Python's 2.0s)
        log("Connected. Waiting 2.0s to stabilize...");
        await new Promise(r => setTimeout(r, 2000));

        // 1. Setup Power (Service 1818)
        try {
            const pSvc = await server.getPrimaryService('00001818-0000-1000-8000-00805f9b34fb');
            const pChar = await pSvc.getCharacteristic(POWER_CHAR_UUID);
            await pChar.startNotifications();
            pChar.addEventListener('characteristicvaluechanged', (e) => {
                const watts = e.target.value.getUint16(2, true);
                document.getElementById('currentPower').textContent = `Current: ${watts}W`;
            });
            log("Power Notifications: Started.");
        } catch (e) { log("Power Setup Error: " + e.message); }

        // 2. The Hunt for Control Char e005
        log("Hunting for Control Characteristic...");
        
        for (const serviceUuid of KNOWN_SERVICES) {
            try {
                // PAUSE 2: Brief gap between service requests to prevent congestion
                await new Promise(r => setTimeout(r, 500));
                
                log(`Querying Service: ${serviceUuid.substring(0,8)}...`);
                const svc = await server.getPrimaryService(serviceUuid);
                
                // Attempting to grab the "file" from this "folder"
                controlChar = await svc.getCharacteristic(WAHOO_CHAR_UUID);
                
                if (controlChar) {
                    log(`>>> MATCH: Found e005 inside ${serviceUuid.substring(0,8)}`);
                    break; 
                }
            } catch (err) {
                // If the characteristic isn't in this service, it throws an error.
                // We catch it here so the loop can keep looking.
                log(`   Check failed for ${serviceUuid.substring(0,8)}`);
            }
        }

        if (controlChar) {
            log("Enabling Control Indications...");
            await controlChar.startNotifications();
            controlChar.addEventListener('characteristicvaluechanged', (e) => {
                log("Trainer Response: 0x" + e.target.value.getUint8(0).toString(16));
            });
            
            // PAUSE 3: Pre-Unlock wait (Matching Python's 1.0s)
            await new Promise(r => setTimeout(r, 1000));
            
            log("Sending Unlock Command [20 EE FC]...");
            await controlChar.writeValueWithResponse(new Uint8Array([0x20, 0xEE, 0xFC]));
            
            // PAUSE 4: Post-Unlock wait (Matching Python's 1.0s)
            await new Promise(r => setTimeout(r, 1000));
            
            log("Setup Complete. KICKR Unlocked.");
            document.getElementById('status').textContent = "Status: READY";
        } else {
            log("FATAL: Characteristic e005 not found in any known service.");
        }

    } catch (error) {
        log("CRASH: " + error.message);
    }
});
    </script>
</body>
</html>