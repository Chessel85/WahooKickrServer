<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Beech 18</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 10px; max-width: 500px; margin: auto; background: #fff; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #connectButton { flex: 2; padding: 15px; font-size: 1.1rem; border-radius: 12px; border: 3px solid #000; font-weight: bold; }
        #status { flex: 1.5; text-align: right; font-weight: bold; margin: 0; font-size: 0.85rem; color: #333; }
        .timer-display { width: 100%; font-size: 4rem; text-align: center; margin-bottom: 10px; padding: 20px 0; border: 3px solid #333; border-radius: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .button-row button { flex: 1; padding: 30px 5px; font-size: 1.4rem; border-radius: 15px; border: 3px solid #000; font-weight: bold; background: #f8f8f8; }
        .info-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .info-cell { flex: 1; border: 3px solid #333; border-radius: 15px; padding: 20px 5px; text-align: center; }
        .info-cell span { font-size: 0.9rem; color: #666; display: block; margin-bottom: 5px; }
        .info-cell strong { font-size: 1.8rem; display: block; }
        .select-row { display: flex; gap: 10px; margin-top: 20px; }
        select { flex: 2; padding: 15px; border-radius: 12px; border: 2px solid #000; font-size: 1rem; }
        #loadWorkoutBtn { flex: 1; padding: 15px; border-radius: 12px; border: 2px solid #000; font-size: 1rem; font-weight: bold; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    </style>
</head>
<body>

    <div class="top-row">
        <button id="connectButton">Connect KICKR</button>
        <div id="status" role="status">Beech 18: Disconnected</div>
    </div>

    <div class="timer-display" role="timer" id="clockContainer" tabIndex="0">
        <strong id="timerDisplay">0:00</strong>
    </div>
    
    <div class="button-row">
        <button id="startPauseButton">Start</button>
        <button id="beepToggleButton">Beeps Off</button>
    </div>

    <div class="info-grid">
        <div class="info-cell" id="wattsCell" tabIndex="0" role="text">
            <span>Target</span>
            <strong id="targetWattsDisplay">150W</strong>
        </div>
        <div class="info-cell" id="durationCell" tabIndex="0" role="text">
            <span>Duration</span>
            <strong id="durationDisplay">Manual</strong>
        </div>
    </div>
    
    <div class="button-row">
        <button id="decreaseButton">- 10W</button>
        <button id="increaseButton">+ 10W</button>
    </div>

    <div id="instructionRegion" aria-live="assertive" class="sr-only"></div>

    <div class="select-row">
        <select id="workoutSelect">
            <option value="manual">Manual Mode</option>
        </select>
        <button id="loadWorkoutBtn">Confirm</button>
    </div>

    <script>
        const GITHUB_USER = 'Chessel85'; 
        const GITHUB_REPO = 'WahooKickrServer';

        let controlChar = null;
        const SERVICE_UUID = '00001818-0000-1000-8000-00805f9b34fb';
        const CONTROL_CHAR_UUID = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

        let targetWatts = 150;
        let secondsElapsed = 0;
        let timerInterval = null;
        let isPaused = true;
        let beepEnabled = false;
        
        let workoutQueue = [];
        let currentSegmentIndex = -1;
        let segmentSecondsRemaining = 0;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playPip(type = 'normal') {
            initAudio();
            if (!audioCtx || audioCtx.state !== 'running') return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'countdown') {
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            } else if (type === 'fanfare') {
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            } else {
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            }
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playEndFanfare() {
            let count = 0;
            const interval = setInterval(() => {
                playPip('fanfare');
                count++;
                if (count >= 6) clearInterval(interval);
            }, 150);
        }

        function formatDurationText(mins) {
            if (mins < 1) return Math.round(mins * 60) + " secs";
            return mins + " mins";
        }

        function updateAriaLabels() {
            const wattsText = document.getElementById('targetWattsDisplay').textContent;
            const durText = document.getElementById('durationDisplay').textContent;
            document.getElementById('wattsCell').setAttribute('aria-label', `Target: ${wattsText}`);
            document.getElementById('durationCell').setAttribute('aria-label', `Duration: ${durText}`);
            document.getElementById('clockContainer').setAttribute('aria-label', `Clock: ${document.getElementById('timerDisplay').textContent}`);
        }

        async function sendPower(watts, durationMins = null) {
            targetWatts = parseInt(watts);
            document.getElementById('targetWattsDisplay').textContent = targetWatts + "W";
            const durDisplay = document.getElementById('durationDisplay');
            if (durationMins !== null && workoutQueue.length > 0) {
                durDisplay.textContent = formatDurationText(durationMins);
            } else {
                durDisplay.textContent = "Manual";
            }
            updateAriaLabels();
            if (!controlChar) return;
            try {
                const data = new Uint8Array([0x42, targetWatts & 0xFF, (targetWatts >> 8) & 0xFF]);
                await controlChar.writeValueWithResponse(data);
            } catch (e) { console.error("BLE Error"); }
        }

        function parseWorkout(text) {
            const lines = text.split('\n');
            let finalQueue = [];
            let currentLoop = [];
            let inLoop = false;
            let reps = 1;
            lines.forEach(line => {
                const clean = line.trim();
                if (!clean || clean.startsWith('#')) return;
                if (clean.toLowerCase().startsWith('startloop')) {
                    inLoop = true;
                    reps = parseInt(clean.split(',')[1]) || 1;
                    currentLoop = [];
                } else if (clean.toLowerCase().startsWith('endloop')) {
                    inLoop = false;
                    for (let i = 0; i < reps; i++) {
                        finalQueue = finalQueue.concat(currentLoop.map(item => ({...item})));
                    }
                } else {
                    const parts = clean.split(',');
                    if (parts.length === 2) {
                        const w = parseInt(parts[0]);
                        const d = parseFloat(parts[1]);
                        if (!isNaN(w) && !isNaN(d)) {
                            const item = { w, d: Math.round(d * 60), dm: d };
                            if (inLoop) currentLoop.push(item); else finalQueue.push(item);
                        }
                    }
                }
            });
            return finalQueue;
        }

        function nextSegment() {
            currentSegmentIndex++;
            if (currentSegmentIndex < workoutQueue.length) {
                const seg = workoutQueue[currentSegmentIndex];
                segmentSecondsRemaining = seg.d;
                document.getElementById('instructionRegion').textContent = `New Target: ${seg.w} Watts`;
                sendPower(seg.w, seg.dm);
            } else {
                isPaused = true;
                clearInterval(timerInterval);
                document.getElementById('startPauseButton').textContent = "Start";
                playEndFanfare();
            }
        }

        function startTimerLogic() {
            isPaused = false;
            document.getElementById('startPauseButton').textContent = "Pause";
            if (workoutQueue.length > 0 && currentSegmentIndex === -1) nextSegment();
            timerInterval = setInterval(() => {
                secondsElapsed++;
                document.getElementById('timerDisplay').textContent = `${Math.floor(secondsElapsed / 60)}:${(secondsElapsed % 60).toString().padStart(2, '0')}`;
                updateAriaLabels();
                if (workoutQueue.length > 0) {
                    segmentSecondsRemaining--;
                    if (segmentSecondsRemaining <= 0) nextSegment();
                    else if (segmentSecondsRemaining <= 3 && currentSegmentIndex < workoutQueue.length - 1) playPip('countdown');
                    else if (beepEnabled) playPip('normal');
                } else if (beepEnabled) {
                    playPip('normal');
                }
            }, 1000);
        }

        // RESTORED ACORN 4 DISCOVERY
        document.getElementById('connectButton').addEventListener('click', async () => {
            initAudio();
            try {
                // Exact discovery logic from Acorn 4
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "KICKR" }],
                    optionalServices: [SERVICE_UUID]
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                controlChar = await service.getCharacteristic(CONTROL_CHAR_UUID);
                await controlChar.startNotifications();
                
                // Keep the sleep for hardware stability
                await new Promise(r => setTimeout(r, 1000));
                
                await controlChar.writeValueWithResponse(new Uint8Array([0x20, 0xEE, 0xFC]));
                document.getElementById('status').textContent = "Beech 18: Connected";
                sendPower(targetWatts);
                playPip('countdown'); 
            } catch (e) { 
                document.getElementById('status').textContent = "Beech 18: Error"; 
            }
        });

        document.getElementById('startPauseButton').addEventListener('click', () => {
            initAudio();
            if (!isPaused) {
                isPaused = true;
                clearInterval(timerInterval);
                document.getElementById('startPauseButton').textContent = "Resume";
            } else {
                if (secondsElapsed === 0) {
                    let count = 3;
                    const launcher = setInterval(() => {
                        playPip('countdown');
                        count--;
                        if (count <= 0) { clearInterval(launcher); startTimerLogic(); }
                    }, 1000);
                } else { startTimerLogic(); }
            }
        });

        document.getElementById('beepToggleButton').addEventListener('click', () => {
            initAudio();
            beepEnabled = !beepEnabled;
            document.getElementById('beepToggleButton').textContent = beepEnabled ? "Beeps On" : "Beeps Off";
            if (beepEnabled) playPip('normal');
        });

        document.getElementById('loadWorkoutBtn').addEventListener('click', async () => {
            const fileName = document.getElementById('workoutSelect').value;
            if (fileName === "manual") { workoutQueue = []; currentSegmentIndex = -1; sendPower(150, null); return; }
            try {
                const response = await fetch(fileName, {cache: "no-store"});
                const text = await response.text();
                workoutQueue = parseWorkout(text);
                currentSegmentIndex = -1;
                document.getElementById('status').textContent = "Beech 18: Ready";
                sendPower(workoutQueue[0].w, workoutQueue[0].dm);
            } catch (e) { document.getElementById('status').textContent = "Beech 18: Error"; }
        });

        async function scanGitHub() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`);
                const files = await response.json();
                const tsFiles = files.filter(f => f.name.startsWith('TS') && f.name.endsWith('.txt'));
                const sel = document.getElementById('workoutSelect');
                tsFiles.forEach(f => {
                    let opt = document.createElement('option');
                    opt.value = f.name; opt.textContent = f.name;
                    sel.appendChild(opt);
                });
            } catch (e) { }
        }

        document.getElementById('increaseButton').addEventListener('click', () => sendPower(targetWatts + 10));
        document.getElementById('decreaseButton').addEventListener('click', () => sendPower(targetWatts - 10));
        
        scanGitHub();
        updateAriaLabels();
    </script>
</body>
</html>