<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatula Debugger</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 600px; margin: auto; line-height: 1.5; }
        .box { border: 3px solid #000; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        button { width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold; cursor: pointer; background: #e0e0e0; }
        select { width: 100%; padding: 15px; font-size: 1.2rem; margin-bottom: 10px; }
        #output { background: #f4f4f4; padding: 15px; border-left: 5px solid #007bff; white-space: pre-wrap; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background: #eee; }
        .error { color: red; font-weight: bold; border: 2px solid red; padding: 10px; }
    </style>
</head>
<body>

    <h1>Spatula File Debugger</h1>
    <p>Use this to confirm the server is serving your TS files correctly.</p>

    <div class="box">
        <label for="fileSelect"><strong>1. Select File:</strong></label>
        <select id="fileSelect">
            <option value="TS01.txt">TS01.txt</option>
            <option value="TS02.txt">TS02.txt</option>
            <option value="TS03.txt">TS03.txt</option>
        </select>
        <button id="readButton">Read and Interpret File</button>
    </div>

    <div id="errorDisplay" class="error" style="display:none;"></div>

    <div id="interpretation" class="box" style="display:none;">
        <h2>Interpretation Results</h2>
        <div id="output"></div>
        
        <table id="resultTable">
            <thead>
                <tr>
                    <th>Step</th>
                    <th>Watts</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        document.getElementById('readButton').addEventListener('click', async () => {
            const fileName = document.getElementById('fileSelect').value;
            const output = document.getElementById('output');
            const errorDisplay = document.getElementById('errorDisplay');
            const tableBody = document.querySelector('#resultTable tbody');
            const interpDiv = document.getElementById('interpretation');

            // Reset UI
            errorDisplay.style.display = 'none';
            interpDiv.style.display = 'none';
            tableBody.innerHTML = '';
            output.textContent = "Fetching " + fileName + "...";

            try {
                const response = await fetch(fileName, { cache: "no-store" });
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                output.textContent = "RAW FILE CONTENT:\n---\n" + text + "\n---";

                // Parsing Logic
                const lines = text.split('\n');
                let parsedQueue = [];
                let loopItems = [];
                let inLoop = false;

                lines.forEach((line, index) => {
                    const clean = line.trim();
                    if (!clean || clean.startsWith('#') || clean.toLowerCase().startsWith('name:')) return;

                    if (clean === 'StartLoop') { inLoop = true; return; }
                    if (clean === 'EndLoop') {
                        inLoop = false;
                        parsedQueue = parsedQueue.concat(loopItems);
                        return;
                    }

                    const parts = clean.split(',');
                    if (parts.length === 2) {
                        const w = parseInt(parts[0]);
                        const d = parseInt(parts[1]);
                        if (!isNaN(w) && !isNaN(d)) {
                            const item = { watts: w, mins: d };
                            if (inLoop) loopItems.push(item);
                            else parsedQueue.push(item);
                        }
                    }
                });

                // Display in Table
                if (parsedQueue.length > 0) {
                    parsedQueue.forEach((item, i) => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).textContent = i + 1;
                        row.insertCell(1).textContent = item.watts + "W";
                        row.insertCell(2).textContent = item.mins + " mins";
                    });
                    interpDiv.style.display = 'block';
                } else {
                    throw new Error("File read successfully, but no valid workout instructions (e.g., 150,5) were found.");
                }

            } catch (err) {
                errorDisplay.textContent = "ERROR: " + err.message;
                errorDisplay.style.display = 'block';
            }
        });
    </script>
</body>
</html>