<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    <h2 id="powerDisplay">Watts: --</h2>

    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const powerDisplay = document.getElementById('powerDisplay');

// These are the official UUIDs for Cycling Power
const CYCLING_POWER_SERVICE = '00001818-0000-1000-8000-00805f9b34fb';
const POWER_MEASUREMENT_CHAR = '00001817-0000-1000-8000-00805f9b34fb';

connectButton.addEventListener('click', async () => {
    try {
        statusText.textContent = "Status: Searching...";

        // 1. Request the device
        // We filter for KICKR but must declare the service as 'optional' 
        // so the browser is allowed to access it after connection.
        const device = await navigator.bluetooth.requestDevice({
            // This tells the phone: "Show me everything you see"
            acceptAllDevices: true,
            optionalServices: [CYCLING_POWER_SERVICE]
        });

        statusText.textContent = "Status: Connecting to " + device.name;
        
        // 2. Connect to the GATT Server
        const server = await device.gatt.connect();

        statusText.textContent = "Status: Handshaking...";
        // A small delay helps the Wahoo hardware stabilize the connection
        await new Promise(resolve => setTimeout(resolve, 1000));

        // 3. Get the Cycling Power Service
        const service = await server.getPrimaryService(CYCLING_POWER_SERVICE);

        // 4. Get the Power Measurement Characteristic
        const characteristic = await service.getCharacteristic(POWER_MEASUREMENT_CHAR);

        // 5. Start notifications (listening for data)
        await characteristic.startNotifications();
        statusText.textContent = "Status: Receiving Data!";

        // 6. Handle the incoming data
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            // According to Bluetooth SIG, power is a 16-bit UINT at offset 2
            const watts = value.getUint16(2, true);
            powerDisplay.textContent = `Watts: ${watts}`;
            
            // Subtle update so VoiceOver knows the page is "alive"
            if (watts % 5 === 0) { 
                statusText.textContent = "Status: Live Data"; 
            }
        });

        // Handle accidental disconnection
        device.addEventListener('gattserverdisconnected', () => {
            statusText.textContent = "Status: Disconnected. Please reconnect.";
            powerDisplay.textContent = "Watts: --";
        });

    } catch (error) {
        // This will print the exact technical error name (e.g., NotAllowedError)
        statusText.textContent = "Status: " + error.name + ": " + error.message;
        console.error(error);
    }
});
    </script>
</body>
</html>