<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Beech 2.0</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 15px; max-width: 500px; margin: auto; }
        button { width: 100%; padding: 25px 10px; font-size: 1.3rem; border-radius: 12px; border: 2px solid #000; background: #f8f8f8; font-weight: bold; }
        .timer-display { width: 100%; font-size: 3.5rem; text-align: center; margin: 10px 0; padding: 20px 0; border: 2px solid #333; border-radius: 12px; display: block; }
        .button-row { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; }
        .button-row button { flex: 1; }
        .power-display { font-size: 2rem; text-align: center; margin: 10px 0; padding: 20px 0; border: 2px solid #333; border-radius: 12px; }
        .instruction-box { background: #eef; padding: 25px; border: 2px dashed #333; border-radius: 12px; text-align: center; font-size: 1.4rem; min-height: 50px; }
        select { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: 2px solid #000; margin-top: 10px; }
    </style>
</head>
<body>

    <h1 id="mainTitle">KICKR Beech 2.0</h1>

    <button id="connectButton">Connect to KICKR</button>
    <p id="status" role="status" style="text-align: center;">Status: Disconnected</p>

    <div class="timer-display" role="timer" aria-label="Elapsed Time">
        <strong id="timerDisplay">0:00</strong>
    </div>
    
    <div class="button-row">
        <button id="startPauseButton">Start Session</button>
        <button id="beepToggleButton" aria-pressed="false">Beep: OFF</button>
    </div>

    <div class="instruction-box" id="instructionRegion" aria-live="assertive" role="region" aria-label="Current Instruction">
        <span id="currentInstruction">Manual Mode</span>
    </div>

    <div class="power-display" id="powerRegion" aria-live="polite">
        <strong id="targetWattsDisplay" aria-label="Target 150 Watts">Target 150W</strong>
    </div>
    
    <div class="button-row">
        <button id="decreaseButton" aria-label="Decrease Power">- 10W</button>
        <button id="increaseButton" aria-label="Increase Power">+ 10W</button>
    </div>

    <label for="workoutSelect" style="display:block; margin-top:20px; font-weight:bold;">Select Training Session:</label>
    <select id="workoutSelect">
        <option value="manual">Manual Mode</option>
        </select>
    <button id="loadWorkoutBtn" style="margin-top:10px; background:#e0e0e0;">Confirm Workout Choice</button>

    <script>
        let controlChar = null;
        const SERVICE_UUID = '00001818-0000-1000-8000-00805f9b34fb';
        const CONTROL_CHAR_UUID = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

        let targetWatts = 150;
        let secondsElapsed = 0;
        let timerInterval = null;
        let isPaused = true;
        let beepEnabled = false;
        
        let workoutQueue = [];
        let currentSegmentIndex = -1;
        let segmentSecondsRemaining = 0;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // VoiceOver and Audio Helpers
        function playPip(isCountdown = false) {
            if (!beepEnabled && !isCountdown) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(isCountdown ? 1200 : 880, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        async function sendPower(watts) {
            targetWatts = watts;
            document.getElementById('targetWattsDisplay').textContent = "Target " + watts + "W";
            document.getElementById('targetWattsDisplay').setAttribute('aria-label', "Target " + watts + " Watts");
            if (!controlChar) return;
            try {
                const data = new Uint8Array([0x42, watts & 0xFF, (watts >> 8) & 0xFF]);
                await controlChar.writeValueWithResponse(data);
            } catch (e) { console.error(e); }
        }

        // PARSER: Handles Name, StartLoop, and EndLoop
        function parseWorkout(text) {
            const lines = text.split('\n');
            let parsed = [];
            let loopItems = [];
            let inLoop = false;

            lines.forEach(line => {
                const clean = line.trim();
                if (clean.startsWith('Name:')) return;
                if (clean === 'StartLoop') { inLoop = true; return; }
                if (clean === 'EndLoop') {
                    inLoop = false;
                    // For now, we expand the loop once. We can add multiplier logic later.
                    parsed = parsed.concat(loopItems); 
                    return;
                }
                const parts = clean.split(',');
                if (parts.length === 2) {
                    const item = { w: parseInt(parts[0]), d: parseInt(parts[1]) * 60 };
                    if (inLoop) loopItems.push(item);
                    else parsed.push(item);
                }
            });
            return parsed;
        }

        function nextSegment() {
            currentSegmentIndex++;
            if (currentSegmentIndex < workoutQueue.length) {
                const seg = workoutQueue[currentSegmentIndex];
                segmentSecondsRemaining = seg.d;
                
                // Update UI and trigger VoiceOver
                const msg = `New Segment: ${seg.w} Watts`;
                document.getElementById('currentInstruction').textContent = msg;
                sendPower(seg.w);
            } else {
                isPaused = true;
                clearInterval(timerInterval);
                document.getElementById('currentInstruction').textContent = "Workout Complete";
            }
        }

        document.getElementById('startPauseButton').addEventListener('click', () => {
            if (isPaused) {
                isPaused = false;
                audioCtx.resume();
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    const mins = Math.floor(secondsElapsed / 60);
                    const secs = secondsElapsed % 60;
                    document.getElementById('timerDisplay').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    
                    if (workoutQueue.length > 0) {
                        segmentSecondsRemaining--;
                        
                        // Countdown Pips at 3, 2, 1 seconds left
                        if (segmentSecondsRemaining <= 3 && segmentSecondsRemaining > 0) {
                            if (segmentSecondsRemaining === 3) {
                                // Move focus to instruction box so VoiceOver reads the upcoming change
                                document.getElementById('instructionRegion').focus();
                            }
                            playPip(true);
                        }
                        
                        if (segmentSecondsRemaining <= 0) {
                            nextSegment();
                        }
                    } else {
                        playPip();
                    }
                }, 1000);
            } else {
                isPaused = true;
                clearInterval(timerInterval);
            }
        });

        // WORKOUT LOADING LOGIC
        // You will need to manually list your TS files here or have a manifest.json
        const knownFiles = ["TS01.txt", "TS02.txt", "TS03.txt"]; 
        const select = document.getElementById('workoutSelect');
        knownFiles.forEach(file => {
            let opt = document.createElement('option');
            opt.value = file;
            opt.innerHTML = file;
            select.appendChild(opt);
        });

        document.getElementById('loadWorkoutBtn').addEventListener('click', async () => {
            const fileName = document.getElementById('workoutSelect').value;
            if (fileName === "manual") {
                workoutQueue = [];
                document.getElementById('currentInstruction').textContent = "Manual Mode";
                return;
            }
            try {
                const response = await fetch(fileName);
                const text = await response.text();
                workoutQueue = parseWorkout(text);
                currentSegmentIndex = -1;
                document.getElementById('currentInstruction').textContent = "Workout Loaded: " + fileName;
            } catch (e) {
                document.getElementById('currentInstruction').textContent = "Error loading file.";
            }
        });

        // Bluetooth Logic (Redstart baseline)
        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "KICKR" }], optionalServices: [SERVICE_UUID]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                controlChar = await service.getCharacteristic(CONTROL_CHAR_UUID);
                await controlChar.startNotifications();
                await new Promise(r => setTimeout(r, 1000));
                await controlChar.writeValueWithResponse(new Uint8Array([0x20, 0xEE, 0xFC]));
                document.getElementById('status').textContent = "Status: Connected";
                sendPower(targetWatts);
            } catch (e) { document.getElementById('status').textContent = "Error: " + e.message; }
        });
    </script>
</body>
</html>