<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.5; }
        button { padding: 10px 15px; margin: 5px 0; cursor: pointer; }
        #debugLog { background: #f4f4f4; border: 1px solid #ccc; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; padding: 10px; margin-top: 10px; }
        .data-display { font-size: 1.2em; font-weight: bold; color: #d32f2f; }
    </style>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    
    <p>Target Power (Watts): <span id="targetWatts" class="data-display">100</span></p>
    <button id="decreaseButton">Minus 10</button>
    <button id="increaseButton">Plus 10</button>

    <p id="currentPower">Current: --</p>
    <p id="cadenceDisplay">Cadence (RPM): --</p>

    <hr>
    <h2>Debug Log</h2>
    <button id="clearLog">Clear Debug Log</button>
    <div id="debugLog"></div>

<script>
    const connectButton = document.getElementById('connectButton');
    const statusText = document.getElementById('status');
    const targetWattsSpan = document.getElementById('targetWatts');
    const currentPowerDisplay = document.getElementById('currentPower');
    const cadenceDisplay = document.getElementById('cadenceDisplay');
    const debugLog = document.getElementById('debugLog');
    const clearLogButton = document.getElementById('clearLog');
    const decreaseButton = document.getElementById('decreaseButton');
    const increaseButton = document.getElementById('increaseButton');

    // Bluetooth UUIDs
    const CYCLING_POWER_SERVICE = '00001818-0000-1000-8000-00805f9b34fb';
    const POWER_MEASUREMENT_CHAR = '00002a63-0000-1000-8000-00805f9b34fb';
    const WAHOO_TRAINER_SERVICE = 'a026ee0d-0a7d-4ab3-97fa-f1500f9feb8b';
    const WAHOO_TRAINER_CHAR = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

    let targetWatts = 100;
    let trainerCharacteristic = null;
    let packetCount = 0;
    let lastRevCount = null;
    let lastRevTime = null;

    function addLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.style.margin = '2px 0';
        logEntry.textContent = `[${timestamp}] ${message}`;
        debugLog.appendChild(logEntry);
        debugLog.scrollTop = debugLog.scrollHeight;
        console.log(message);
    }

    clearLogButton.addEventListener('click', () => {
        debugLog.innerHTML = '';
        addLog('Debug log cleared');
    });

    async function sendPowerTarget(watts) {
        if (!trainerCharacteristic) {
            addLog("Command failed: No trainer control available");
            return;
        }
        try {
            // Wahoo KICKR v1 uses 0x42 for Erg Mode set point
            const cmd = new Uint8Array([0x42, watts & 0xFF, (watts >> 8) & 0xFF]);
            await trainerCharacteristic.writeValue(cmd);
            const cmdHex = Array.from(cmd).map(b => b.toString(16).padStart(2, '0')).join(' ');
            addLog(`Command sent: Set ${watts}W (bytes: ${cmdHex})`);
        } catch (error) {
            addLog(`Command error: ${error.message}`);
        }
    }

    decreaseButton.addEventListener('click', async () => {
        targetWatts = Math.max(10, targetWatts - 10);
        targetWattsSpan.textContent = targetWatts;
        await sendPowerTarget(targetWatts);
    });

    increaseButton.addEventListener('click', async () => {
        targetWatts += 10;
        targetWattsSpan.textContent = targetWatts;
        await sendPowerTarget(targetWatts);
    });

    connectButton.addEventListener('click', async () => {
        try {
            statusText.textContent = "Status: Searching...";
            addLog('=== NEW CONNECTION ATTEMPT ===');
            
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [CYCLING_POWER_SERVICE] }],
                optionalServices: [WAHOO_TRAINER_SERVICE]
            });

            statusText.textContent = `Status: ${device.name} Selected. Connecting...`;
            addLog(`Device selected: ${device.name}`);

            const server = await device.gatt.connect();
            addLog('GATT server connected');

            // Get Power Service
            const powerService = await server.getPrimaryService(CYCLING_POWER_SERVICE);
            const powerCharacteristic = await powerService.getCharacteristic(POWER_MEASUREMENT_CHAR);
            
            // Get Trainer Control Service
            try {
                const trainerService = await server.getPrimaryService(WAHOO_TRAINER_SERVICE);
                trainerCharacteristic = await trainerService.getCharacteristic(WAHOO_TRAINER_CHAR);
                
                addLog('Trainer control service found');
                
                // Unlock command for KICKR
                const unlockCmd = new Uint8Array([0x20, 0xEE, 0xFC]);
                await trainerCharacteristic.writeValue(unlockCmd);
                addLog('Unlock command sent');
                
                await sendPowerTarget(targetWatts);
                statusText.textContent = "Status: Connected with Control";
            } catch (e) {
                addLog("Trainer Control not available. Using Read-Only.");
                statusText.textContent = "Status: Connected (Read-Only)";
            }

            // Power/Cadence Notifications
            await powerCharacteristic.startNotifications();
            powerCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                const value = event.target.value;
                const flags = value.getUint8(0);
                const watts = value.getUint16(2, true);
                currentPowerDisplay.textContent = `Current: ${watts}W`;

                // Calculate Cadence if flags indicate presence (bit 2)
                if (value.byteLength >= 8 && (flags & 0x04)) {
                    const revCount = value.getUint16(4, true);
                    const eventTime = value.getUint16(6, true);
                    
                    if (lastRevCount !== null && lastRevTime !== null) {
                        const revDelta = (revCount - lastRevCount + 65536) % 65536;
                        const timeDelta = (eventTime - lastRevTime + 65536) % 65536;
                        
                        if (timeDelta > 0 && revDelta > 0) {
                            const rpm = Math.round((revDelta / (timeDelta / 1024)) * 60);
                            if (rpm > 20 && rpm < 200) {
                                cadenceDisplay.textContent = `Cadence (RPM): ${rpm}`;
                            }
                        }
                    }
                    lastRevCount = revCount;
                    lastRevTime = eventTime;
                }
            });

            device.addEventListener('gattserverdisconnected', () => {
                statusText.textContent = "Status: Disconnected";
                addLog('Device disconnected');
            });

        } catch (error) {
            statusText.textContent = `Status: Error - ${error.message}`;
            addLog(`ERROR: ${error.message}`);
        }
    });
</script>
</body>
</html>