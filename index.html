<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Acorn3</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 400px; margin: auto; }
        button { width: 100%; padding: 25px; margin: 10px 0; font-size: 1.4rem; border-radius: 12px; border: 2px solid #000; background: #f8f8f8; color: black; }
        .data-display { font-size: 1.8rem; text-align: center; margin: 15px 0; padding: 20px; border: 2px solid #333; border-radius: 12px; }
        #debugLog { background: #000; color: #0f0; font-family: monospace; font-size: 10px; height: 80px; overflow-y: scroll; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <h1 id="mainTitle">KICKR Acorn3</h1>

    <button id="connectButton">Connect to KICKR</button>
    <p id="status" role="status">Status: Disconnected</p>

    <div class="data-display" role="timer" aria-label="Elapsed Time">
        <strong id="timerDisplay">0:00</strong>
    </div>
    
    <button id="startPauseButton">Start Session</button>
    <button id="beepToggleButton" aria-pressed="false">Beep: OFF</button>

    <div class="data-display" id="powerRegion" aria-live="assertive" role="text">
        <strong id="targetWattsDisplay" aria-label="Target 150 Watts">Target 150W</strong>
    </div>
    
    <div style="display: flex; gap: 15px;">
        <button id="decreaseButton" aria-label="Decrease Power">- 10W</button>
        <button id="increaseButton" aria-label="Increase Power">+ 10W</button>
    </div>

    <div id="debugLog" role="log" aria-label="System Logs">
        [Acorn3 Ready]<br>
    </div>

    <script>
        let controlChar = null;
        const SERVICE_UUID = '00001818-0000-1000-8000-00805f9b34fb';
        const CONTROL_CHAR_UUID = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

        let targetWatts = 150;
        let secondsElapsed = 0;
        let timerInterval = null;
        let isPaused = true;
        let beepEnabled = false;
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function log(msg) {
            const el = document.getElementById('debugLog');
            el.innerHTML += msg + "<br>";
            el.scrollTop = el.scrollHeight;
        }

        function playPip() {
            if (!beepEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function updatePowerUI() {
            const display = document.getElementById('targetWattsDisplay');
            // Merges "Target" and "Watts" for a single VoiceOver phrase
            display.textContent = "Target " + targetWatts + "W";
            display.setAttribute('aria-label', "Target " + targetWatts + " Watts");
        }

        document.getElementById('startPauseButton').addEventListener('click', () => {
            if (isPaused) {
                isPaused = false;
                audioCtx.resume();
                document.getElementById('startPauseButton').textContent = "Pause Session";
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    const mins = Math.floor(secondsElapsed / 60);
                    const secs = secondsElapsed % 60;
                    document.getElementById('timerDisplay').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    playPip();
                }, 1000);
            } else {
                isPaused = true;
                clearInterval(timerInterval);
                document.getElementById('startPauseButton').textContent = "Start Session";
            }
        });

        document.getElementById('beepToggleButton').addEventListener('click', () => {
            beepEnabled = !beepEnabled;
            audioCtx.resume();
            document.getElementById('beepToggleButton').textContent = beepEnabled ? "Beep: ON" : "Beep: OFF";
            document.getElementById('beepToggleButton').setAttribute('aria-pressed', beepEnabled);
        });

        async function sendPower(watts) {
            if (!controlChar) return;
            try {
                const data = new Uint8Array([0x42, watts & 0xFF, (watts >> 8) & 0xFF]);
                await controlChar.writeValueWithResponse(data);
            } catch (e) { log("Err: " + e.message); }
        }

        document.getElementById('increaseButton').addEventListener('click', () => {
            targetWatts += 10;
            updatePowerUI();
            sendPower(targetWatts);
        });

        document.getElementById('decreaseButton').addEventListener('click', () => {
            targetWatts = Math.max(10, targetWatts - 10);
            updatePowerUI();
            sendPower(targetWatts);
        });

        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "KICKR" }],
                    optionalServices: [SERVICE_UUID]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                controlChar = await service.getCharacteristic(CONTROL_CHAR_UUID);
                await controlChar.startNotifications();
                await new Promise(r => setTimeout(r, 1000));
                await controlChar.writeValueWithResponse(new Uint8Array([0x20, 0xEE, 0xFC]));
                document.getElementById('status').textContent = "Status: Connected";
                log("Unlocked.");
            } catch (e) { log("Error: " + e.message); }
        });
    </script>
</body>
</html>