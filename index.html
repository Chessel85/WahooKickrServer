<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Diagnostic Tool</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #121212; color: #e0e0e0; }
        .box { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; }
        button { background: #007aff; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: bold; margin-top: 5px; }
        #log { font-family: monospace; font-size: 11px; background: #000; padding: 10px; border-radius: 5px; height: 300px; overflow-y: auto; white-space: pre-wrap; color: #00ff00; }
        .stat { font-size: 20px; color: #00ff00; font-weight: bold; }
    </style>
</head>
<body>

    <div class="box">
        <h3>1. Discovery</h3>
        <button id="btnConnect">SCAN & DIAGNOSE</button>
        <p id="status" style="font-size: 12px; color: #888;">Ready.</p>
    </div>

    <div class="box">
        <div style="display:flex; justify-content: space-around; text-align: center;">
            <div>POWER<br><span id="valPower" class="stat">--</span></div>
            <div>CADENCE<br><span id="valCad" class="stat">--</span></div>
            <div>TARGET<br><span id="valTarget" class="stat">100</span></div>
        </div>
        <div style="display:flex; gap: 5px; margin-top:10px;">
            <button id="btnDown">-10</button>
            <button id="btnUp">+10</button>
        </div>
    </div>

    <div class="box">
        <h3>System Log</h3>
        <div id="log">Waiting for connection...</div>
    </div>

<script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    let trainerChar = null;
    let targetPower = 100;

    function addLog(msg) {
        const time = new Date().toLocaleTimeString().split(' ')[0];
        logEl.innerText += `\n[${time}] ${msg}`;
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
    }

    // Generic function to set power
    async function updatePower(p) {
        if (!trainerChar) return;
        try {
            const data = new Uint8Array([0x42, p & 0xFF, (p >> 8) & 0xFF]);
            await trainerChar.writeValue(data);
            addLog(`SENT POWER: ${p}W`);
        } catch (e) {
            addLog(`WRITE ERROR: ${e.name} - ${e.message}`);
        }
    }

    document.getElementById('btnUp').onclick = () => { targetPower += 10; document.getElementById('valTarget').innerText = targetPower; updatePower(targetPower); };
    document.getElementById('btnDown').onclick = () => { targetPower -= 10; document.getElementById('valTarget').innerText = targetPower; updatePower(targetPower); };

    document.getElementById('btnConnect').onclick = async () => {
        try {
            logEl.innerText = "Starting Discovery...";
            
            // We filter for the KICKR name prefix to be less restrictive
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'KICKR' }, { namePrefix: 'WAHOO' }],
                optionalServices: [
                    '00001818-0000-1000-8000-00805f9b34fb', // Cycling Power
                    'a026ee0d-0a7d-4ab3-97fa-f1500f9feb8b', // Wahoo Trainer
                    '0000181c-0000-1000-8000-00805f9b34fb'  // FTMS (Standard Control)
                ]
            });

            statusEl.innerText = "Connecting to GATT...";
            const server = await device.gatt.connect();
            addLog("Connected to GATT Server.");

            // DIAGNOSTIC: List all available services
            addLog("Fetching Primary Services...");
            const services = await server.getPrimaryServices();
            addLog(`Found ${services.length} services.`);

            for (const service of services) {
                addLog(`SERVICE: ${service.uuid}`);
                
                // Inspect Cycling Power Service
                if (service.uuid.includes('1818')) {
                    const char = await service.getCharacteristic('00002a63-0000-1000-8000-00805f9b34fb');
                    await char.startNotifications();
                    char.oncharacteristicvaluechanged = handleData;
                    addLog("  -> Power Notifications Active");
                }

                // Look for Wahoo Control Characteristic
                if (service.uuid.includes('a026ee0d')) {
                    trainerChar = await service.getCharacteristic('a026e005-0a7d-4ab3-97fa-f1500f9feb8b');
                    addLog("  -> Wahoo Control Char Found!");
                    
                    // Unlock attempt
                    addLog("  -> Sending Unlock (0x20EEFC)...");
                    await trainerChar.writeValue(new Uint8Array([0x20, 0xEE, 0xFC]));
                    addLog("  -> Unlock Sent.");
                }
                
                // Check if it supports modern FTMS (standard control)
                if (service.uuid.includes('181c')) {
                    addLog("  -> FTMS Service Found (Unit supports modern standard)");
                }
            }

            statusEl.innerText = "Connected: Check Logs";
            if (trainerChar) await updatePower(targetPower);

        } catch (err) {
            addLog(`FATAL ERROR: ${err.name} - ${err.message}`);
            statusEl.innerText = "Connection Failed.";
        }
    };

    function handleData(event) {
        const v = event.target.value;
        const watts = v.getUint16(2, true);
        document.getElementById('valPower').innerText = watts;

        // Cadence (Bit 2 of Flags check)
        const flags = v.getUint8(0);
        if (v.byteLength >= 8 && (flags & 0x04)) {
            // Basic cadence update logic
            const revs = v.getUint16(4, true);
            const time = v.getUint16(6, true);
            // Simple RPM display logic (simplified for diagnostics)
            document.getElementById('valCad').innerText = "OK"; 
        }
    }
</script>
</body>
</html>