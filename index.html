<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Scanner - Edinburgh</title>
</head>
<body>
    <h1>KICKR Service Scanner</h1>
    <p style="font-size: 0.8em; color: gray;">Version: Edinburgh</p>
    
    <button id="connectButton">Scan & List Services</button>
    <p id="status">Status: Idle</p>
    
    <div id="debugLog" style="background: #000; color: #0f0; border: 1px solid #333; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 11px; height: 350px; overflow-y: scroll;">
        [Edinburgh Ready] Tap button to begin discovery...<br>
    </div>

    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const debugLog = document.getElementById('debugLog');

function log(msg) {
    const now = new Date();
    const time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
    debugLog.innerHTML += `[${time}] ${msg}<br>`;
    debugLog.scrollTop = debugLog.scrollHeight;
}

connectButton.addEventListener('click', async () => {
    try {
        log("Initiating Scan (Accept All)...");
        statusText.textContent = "Status: Searching...";
        
        // We use acceptAllDevices so the browser doesn't hide "unlisted" services
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true
        });
        
        log("Device Selected: " + (device.name || "Unknown Device"));
        statusText.textContent = "Status: Connecting...";
        
        const server = await device.gatt.connect();
        log("GATT Connected.");

        log("Waiting 2.0s for GATT table to populate...");
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        statusText.textContent = "Status: Discovering Services...";
        log("Fetching Primary Services...");
        
        // This requests every service the device is broadcasting
        const services = await server.getPrimaryServices();
        
        log(`Found ${services.length} services:`);
        log("--------------------------------");

        for (const service of services) {
            log(`Service: ${service.uuid}`);
            
            // Optional: Try to see if our target characteristic lives inside this service
            try {
                const chars = await service.getCharacteristics();
                for (const char of chars) {
                    if (char.uuid.includes("a026e005")) {
                        log(`>>> MATCH FOUND: a026e005 is inside this service!`);
                    }
                }
            } catch (e) {
                // Some services might be restricted by the browser
                log(`   (Characteristics hidden for this service)`);
            }
        }
        
        log("--------------------------------");
        log("Scan Complete.");
        statusText.textContent = "Status: Scan Finished";
        
        device.addEventListener('gattserverdisconnected', () => {
            log("Disconnected.");
            statusText.textContent = "Status: Disconnected.";
        });
        
    } catch (error) {
        log("SCAN ERROR: " + error.message);
        statusText.textContent = "Status: Error";
    }
});
    </script>
</body>
</html>