<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    <h2 id="powerDisplay">Watts: --</h2>

    <script>
        const connectButton = document.getElementById('connectButton');
        const statusText = document.getElementById('status');
        const powerDisplay = document.getElementById('powerDisplay');

        connectButton.addEventListener('click', async () => {
            try {
                // Clear any previous error text
                statusText.textContent = "Status: Searching...";
                
                // Using the standard UUID for Cycling Power
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x1818] }]
                });

                statusText.textContent = "Status: Connecting to " + device.name;
                const server = await device.gatt.connect();
                
                statusText.textContent = "Status: Handshaking...";
                await new Promise(resolve => setTimeout(resolve, 1000));

                // ONLY ONE SERVICE DECLARATION HERE
                const cyclingService = await server.getPrimaryService(0x1818);
                
                statusText.textContent = "Status: Finding Power Room...";
                const characteristic = await cyclingService.getCharacteristic(0x1817);

                await characteristic.startNotifications();
                statusText.textContent = "Status: Receiving Data!";

                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value;
                    // Read 16-bit power value at offset 2
                    const watts = value.getUint16(2, true); 
                    powerDisplay.textContent = `Watts: ${watts}`;
                });

            } catch (error) {
                // This will tell us if it's a Permission error or a Code error
                statusText.textContent = "Status: Error - " + error;
                console.error(error);
            }
        });
    </script>
</body>
</html>