<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        p {
            font-size: 18px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    <p id="targetPower" tabindex="0">Target: 100W</p>
    <p id="cadenceDisplay">Cadence: -- RPM</p>
    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const targetPowerDisplay = document.getElementById('targetPower');
const cadenceDisplay = document.getElementById('cadenceDisplay');

// Wahoo-specific UUIDs from your working Python script
const CYCLING_POWER_SERVICE = '00001818-0000-1000-8000-00805f9b34fb';
const POWER_MEASUREMENT_CHAR = '00002a63-0000-1000-8000-00805f9b34fb';
const WAHOO_TRAINER_SERVICE = 'a026ee0d-0a7d-4ab3-97fa-f1500f9feb8b';
const WAHOO_TRAINER_CHAR = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

let targetWatts = 100;
let trainerCharacteristic = null;
let device = null;

// Handle swipe gestures for adjusting target power
let touchStartY = 0;
targetPowerDisplay.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
});

targetPowerDisplay.addEventListener('touchend', async (e) => {
    const touchEndY = e.changedTouches[0].clientY;
    const diff = touchStartY - touchEndY;
    
    // Swipe up = increase, swipe down = decrease
    if (Math.abs(diff) > 30) { // Minimum swipe distance
        if (diff > 0) {
            // Swiped up
            targetWatts += 10;
        } else {
            // Swiped down
            targetWatts = Math.max(10, targetWatts - 10); // Don't go below 10W
        }
        
        targetPowerDisplay.textContent = `Target: ${targetWatts}W`;
        
        // Send command to KICKR if connected
        if (trainerCharacteristic) {
            try {
                const cmd = new Uint8Array([0x42, targetWatts & 0xFF, (targetWatts >> 8) & 0xFF]);
                await trainerCharacteristic.writeValue(cmd);
            } catch (error) {
                console.error("Error setting power:", error);
            }
        }
    }
});

connectButton.addEventListener('click', async () => {
    try {
        statusText.textContent = "Status: Searching...";
        
        // Request device with both services
        device = await navigator.bluetooth.requestDevice({
            filters: [{
                services: [CYCLING_POWER_SERVICE]
            }],
            optionalServices: [CYCLING_POWER_SERVICE, WAHOO_TRAINER_SERVICE]
        });
        
        const deviceName = device.name || "KICKR Device";
        statusText.textContent = `Status: ${deviceName} Selected. Connecting...`;
        
        const server = await device.gatt.connect();
        statusText.textContent = "Status: Handshaking with Trainer...";
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Get power measurement for cadence
        const powerService = await server.getPrimaryService(CYCLING_POWER_SERVICE);
        const powerCharacteristic = await powerService.getCharacteristic(POWER_MEASUREMENT_CHAR);
        
        // Get trainer control
        const trainerService = await server.getPrimaryService(WAHOO_TRAINER_SERVICE);
        trainerCharacteristic = await trainerService.getCharacteristic(WAHOO_TRAINER_CHAR);
        
        // Send unlock command (from your Python script)
        statusText.textContent = "Status: Unlocking trainer...";
        const unlockCmd = new Uint8Array([0x20, 0xEE, 0xFC]);
        await trainerCharacteristic.writeValue(unlockCmd);
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Set initial target power
        const initialCmd = new Uint8Array([0x42, targetWatts & 0xFF, (targetWatts >> 8) & 0xFF]);
        await trainerCharacteristic.writeValue(initialCmd);
        
        // Start listening for power/cadence data
        await powerCharacteristic.startNotifications();
        statusText.textContent = "Status: Connected and Receiving Data!";
        
        powerCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            
            // Parse cadence from the power measurement data
            // Cadence is typically at bytes 4-5 if the flag bit indicates it's present
            const flags = value.getUint8(0);
            
            // Check if cadence is present (bit 2 of flags)
            if (flags & 0x04) {
                const cadence = value.getUint16(4, true);
                cadenceDisplay.textContent = `Cadence: ${cadence} RPM`;
            }
        });
        
        device.addEventListener('gattserverdisconnected', () => {
            statusText.textContent = "Status: Disconnected. Please scan again.";
            cadenceDisplay.textContent = "Cadence: -- RPM";
            trainerCharacteristic = null;
        });
        
    } catch (error) {
        statusText.textContent = "Status: Error - " + (error.message || "Unknown error");
        console.error("Bluetooth Error:", error);
    }
});
    </script>
</body>
</html>