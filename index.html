<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control - Redstart</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <p style="font-size: 0.8em; color: gray;">Version: Redstart</p>
    
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    
    <p>Target Power: <span id="targetWatts">100</span>W</p>
    <button id="decreaseButton">- 10W</button>
    <button id="increaseButton">+ 10W</button>
    
    <p id="currentPower">Current: -- W</p>

    <div id="debugLog" style="background: #000; color: #0f0; border: 1px solid #333; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 11px; height: 200px; overflow-y: scroll;">
        [Redstart Ready] Waiting for user...<br>
    </div>

    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const targetWattsSpan = document.getElementById('targetWatts');
const currentPowerDisplay = document.getElementById('currentPower');
const decreaseButton = document.getElementById('decreaseButton');
const increaseButton = document.getElementById('increaseButton');
const debugLog = document.getElementById('debugLog');

function log(msg) {
    const now = new Date();
    const time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
    debugLog.innerHTML += `[${time}] ${msg}<br>`;
    debugLog.scrollTop = debugLog.scrollHeight;
}

// DEFINITIVE UUIDs FOR YOUR KICKR
const CYCLING_POWER_SERVICE = '00001818-0000-1000-8000-00805f9b34fb';
const POWER_MEASUREMENT_CHAR = '00002a63-0000-1000-8000-00805f9b34fb';
const WAHOO_TRAINER_CHAR = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

let targetWatts = 100;
let controlCharacteristic = null;

async function sendPowerToKickr(watts) {
    if (!controlCharacteristic) {
        log("No control handle available.");
        return;
    }
    try {
        // Command 0x42 + watts in 16-bit little endian
        const data = new Uint8Array([0x42, watts & 0xFF, (watts >> 8) & 0xFF]);
        await controlCharacteristic.writeValueWithResponse(data);
        log(`Sent Command: ${watts}W`);
    } catch (error) {
        log("Send Error: " + error.message);
    }
}

decreaseButton.addEventListener('click', async () => {
    targetWatts = Math.max(10, targetWatts - 10);
    targetWattsSpan.textContent = targetWatts;
    await sendPowerToKickr(targetWatts);
});

increaseButton.addEventListener('click', async () => {
    targetWatts += 10;
    targetWattsSpan.textContent = targetWatts;
    await sendPowerToKickr(targetWatts);
});

connectButton.addEventListener('click', async () => {
    try {
        log("Requesting device (Filtered to 1818)...");
        statusText.textContent = "Status: Searching...";
        
        const device = await navigator.bluetooth.requestDevice({
            filters: [{
                services: [CYCLING_POWER_SERVICE]
            }]
        });
        
        log("Selected: " + (device.name || "Unknown"));
        statusText.textContent = "Status: Connecting...";
        
        const server = await device.gatt.connect();
        log("GATT Connected.");
        
        log("Delaying 2.0s (Stabilizing)...");
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        log("Accessing Cycling Power Service...");
        const powerService = await server.getPrimaryService(CYCLING_POWER_SERVICE);
        
        // 1. Setup Power Data
        const powerChar = await powerService.getCharacteristic(POWER_MEASUREMENT_CHAR);
        log("Starting Power Notifications...");
        await powerChar.startNotifications();
        powerChar.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            const watts = value.getUint16(2, true);
            currentPowerDisplay.textContent = `Current: ${watts}W`;
        });

        // 2. Setup Trainer Control (found in same service 1818)
        log("Accessing Control Characteristic...");
        controlCharacteristic = await powerService.getCharacteristic(WAHOO_TRAINER_CHAR);
        
        log("Starting Control Indications...");
        await controlCharacteristic.startNotifications();
        controlCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
            log("Trainer Response: 0x" + event.target.value.getUint8(0).toString(16));
        });

        log("Delaying 1.0s (Pre-Unlock)...");
        await new Promise(resolve => setTimeout(resolve, 1000));

        log("Sending Unlock [20 EE FC]...");
        const unlockCmd = new Uint8Array([0x20, 0xEE, 0xFC]);
        await controlCharacteristic.writeValueWithResponse(unlockCmd);
        
        log("Delaying 1.0s (Confirmation)...");
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        statusText.textContent = "Status: Ready!";
        log("Logic complete. Ready for power adjustment.");
        
    } catch (error) {
        log("ERROR: " + error.message);
        statusText.textContent = "Status: Error - " + (error.message || "Unknown");
    }
});
    </script>
</body>
</html>