<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    
    <p>Target Power: <span id="targetWatts">100</span>W</p>
    <button id="decreaseButton">- 10W</button>
    <button id="increaseButton">+ 10W</button>
    
    <p id="currentPower">Current: -- W</p>
    <p id="cadenceDisplay">Cadence: -- RPM</p>
    
    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const targetWattsSpan = document.getElementById('targetWatts');
const currentPowerDisplay = document.getElementById('currentPower');
const cadenceDisplay = document.getElementById('cadenceDisplay');
const decreaseButton = document.getElementById('decreaseButton');
const increaseButton = document.getElementById('increaseButton');

const CYCLING_POWER_SERVICE = '00001818-0000-1000-8000-00805f9b34fb';
const POWER_MEASUREMENT_CHAR = '00002a63-0000-1000-8000-00805f9b34fb';

let targetWatts = 100;

decreaseButton.addEventListener('click', () => {
    targetWatts = Math.max(10, targetWatts - 10);
    targetWattsSpan.textContent = targetWatts;
});

increaseButton.addEventListener('click', () => {
    targetWatts += 10;
    targetWattsSpan.textContent = targetWatts;
});

connectButton.addEventListener('click', async () => {
    try {
        statusText.textContent = "Status: Searching...";
        
        const device = await navigator.bluetooth.requestDevice({
            filters: [{
                services: [CYCLING_POWER_SERVICE]
            }],
            optionalServices: [CYCLING_POWER_SERVICE]
        });
        
        const deviceName = device.name || "KICKR Device";
        statusText.textContent = `Status: ${deviceName} Selected. Connecting...`;
        
        const server = await device.gatt.connect();
        statusText.textContent = "Status: Handshaking with Trainer...";
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const service = await server.getPrimaryService(CYCLING_POWER_SERVICE);
        const characteristic = await service.getCharacteristic(POWER_MEASUREMENT_CHAR);
        
        await characteristic.startNotifications();
        statusText.textContent = "Status: Receiving Data!";
        
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const watts = value.getUint16(2, true);
            currentPowerDisplay.textContent = `Current: ${watts}W`;
            
            // Try to read cadence if present
            try {
                if (value.byteLength >= 6 && (flags & 0x04)) {
                    const cadence = value.getUint16(4, true);
                    if (cadence > 0 && cadence < 255) {
                        cadenceDisplay.textContent = `Cadence: ${cadence} RPM`;
                    }
                }
            } catch (e) {
                console.log("Cadence not available");
            }
        });
        
        device.addEventListener('gattserverdisconnected', () => {
            statusText.textContent = "Status: Disconnected. Please scan again.";
            currentPowerDisplay.textContent = "Current: -- W";
            cadenceDisplay.textContent = "Cadence: -- RPM";
        });
        
    } catch (error) {
        statusText.textContent = "Status: Error - " + (error.message || "Unknown error");
        console.error("Bluetooth Error:", error);
    }
});
    </script>
</body>
</html>