<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KICKR Control</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    <ul id="deviceList"></ul>

    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const powerDisplay = document.createElement('h2'); // We'll add a big display for watts
document.body.appendChild(powerDisplay);
powerDisplay.textContent = "Watts: --";

connectButton.addEventListener('click', async () => {
    try {
        statusText.textContent = "Status: Searching...";
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [0x1818] }] // 0x1818 is the standard Cycling Power Service
        });

        const server = await device.gatt.connect();
        statusText.textContent = "Status: Connected. Fetching Power...";

        // 1. Get the Cycling Power Service
        const service = await server.getPrimaryService(0x1818);

        // 2. Get the Power Measurement Characteristic
        const characteristic = await service.getCharacteristic(0x1817);

        // 3. Start listening for data
        await characteristic.startNotifications();
        
        statusText.textContent = "Status: Receiving Data!";

        characteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            // The Bluetooth standard says Power is a 16-bit integer at offset 2
            const watts = value.getUint16(2, true); 
            powerDisplay.textContent = `Watts: ${watts}`;
        });

    } catch (error) {
        statusText.textContent = "Status: Error - " + error;
    }
});
    </script>
</body>
</html>