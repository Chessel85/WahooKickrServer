<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KICKR Sidewinder v3</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #000; color: #fff; text-align: center; }
        button { background: #3498db; color: #fff; border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; margin: 5px 0; }
        #log { font-family: monospace; font-size: 10px; color: #00ff00; text-align: left; background: #111; padding: 10px; height: 350px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <button id="connectBtn">1. CONNECT & AUTH</button>
    <button id="btnStart" style="background: #2ecc71;">2. SEND START (0x07)</button>
    <button id="btnSweep" style="background: #e67e22;">3. SWEEP (VALUE + STATUS)</button>
    <div id="log">Awaiting connection...</div>

<script>
    const SERVICE_WAHOO = 'a026ee01-0a7d-4ab3-97fa-f1500f9feb8b';
    const CHAR_CONTROL = 'a026e002-0a7d-4ab3-97fa-f1500f9feb8b';
    let controlChar = null;

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerText += `\n> ${m}`;
        l.scrollTop = l.scrollHeight;
    }

    document.getElementById('connectBtn').onclick = async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'KICKR' }, { namePrefix: 'WAHOO' }],
                optionalServices: [SERVICE_WAHOO]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_WAHOO);
            controlChar = await service.getCharacteristic(CHAR_CONTROL);
            await controlChar.startNotifications();
            
            controlChar.oncharacteristicvaluechanged = (e) => {
                const hex = Array.from(new Uint8Array(e.target.value.buffer)).map(b => b.toString(16).padStart(2,'0')).join(' ');
                addLog(`KICKR REPLY: ${hex}`);
            };

            await controlChar.writeValue(new Uint8Array([0x20, 0xEE, 0xFC])); 
            await new Promise(r => setTimeout(r, 500));
            await controlChar.writeValue(new Uint8Array([0x03])); 
            addLog("AUTH SENT. Wait for 01 03 09...");
        } catch (err) { addLog("Err: " + err.message); }
    };

    document.getElementById('btnStart').onclick = () => controlChar.writeValue(new Uint8Array([0x07]));

    document.getElementById('btnSweep').onclick = async () => {
        for (let i = 0; i <= 200; i += 40) {
            addLog(`Setting Resistance: ${i}`);
            // Send Resistance
            await controlChar.writeValue(new Uint8Array([0x04, i & 0xFF, (i >> 8) & 0xFF]));
            await new Promise(r => setTimeout(r, 800));
            // Request Status OpCode (guessing 0x00 for status in this mode)
            addLog("Polling Status...");
            await controlChar.writeValue(new Uint8Array([0x00]));
            await new Promise(r => setTimeout(r, 800));
        }
    };
</script>
</body>
</html>