<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKR Control</title>
</head>
<body>
    <h1>Wahoo KICKR Dashboard</h1>
    <button id="connectButton">Scan for KICKR</button>
    <p id="status">Status: Disconnected</p>
    <p id="version">Version bluebottle</p>
    
    <p>Target Power (Watts): <span id="targetWatts">100</span></p>
    <button id="decreaseButton" aria-label="Decrease target power by 10 watts">Minus 10</button>
    <button id="increaseButton" aria-label="Increase target power by 10 watts">Plus 10</button>
    
    <p id="currentPower">Current: --</p>
    <p id="cadenceDisplay">Cadence (RPM): --</p>
    
    <h2>Debug Information</h2>
    <p id="controlStatus">Control: Not connected</p>
    <p id="lastCommand">Last command: None</p>
    <p id="dataInfo">Data packets: 0</p>
    <p id="cadenceDebug">Cadence data: Not available</p>
    
    <script>
const connectButton = document.getElementById('connectButton');
const statusText = document.getElementById('status');
const targetWattsSpan = document.getElementById('targetWatts');
const currentPowerDisplay = document.getElementById('currentPower');
const cadenceDisplay = document.getElementById('cadenceDisplay');
const controlStatus = document.getElementById('controlStatus');
const lastCommand = document.getElementById('lastCommand');
const dataInfo = document.getElementById('dataInfo');
const cadenceDebug = document.getElementById('cadenceDebug');
const decreaseButton = document.getElementById('decreaseButton');
const increaseButton = document.getElementById('increaseButton');

const CYCLING_POWER_SERVICE = '00001818-0000-1000-8000-00805f9b34fb';
const POWER_MEASUREMENT_CHAR = '00002a63-0000-1000-8000-00805f9b34fb';
const WAHOO_TRAINER_SERVICE = 'a026ee0d-0a7d-4ab3-97fa-f1500f9feb8b';
const WAHOO_TRAINER_CHAR = 'a026e005-0a7d-4ab3-97fa-f1500f9feb8b';

let targetWatts = 100;
let trainerCharacteristic = null;
let packetCount = 0;

async function sendPowerTarget(watts) {
    if (!trainerCharacteristic) {
        lastCommand.textContent = "Last command: Failed - no control connection";
        return;
    }
    
    try {
        const cmd = new Uint8Array([0x42, watts & 0xFF, (watts >> 8) & 0xFF]);
        await trainerCharacteristic.writeValue(cmd);
        const cmdHex = Array.from(cmd).map(b => b.toString(16).padStart(2, '0')).join(' ');
        lastCommand.textContent = `Last command: Set ${watts}W (bytes: ${cmdHex})`;
    } catch (error) {
        lastCommand.textContent = `Last command: Error - ${error.message}`;
    }
}

decreaseButton.addEventListener('click', async () => {
    targetWatts = Math.max(10, targetWatts - 10);
    targetWattsSpan.textContent = targetWatts;
    await sendPowerTarget(targetWatts);
});

increaseButton.addEventListener('click', async () => {
    targetWatts += 10;
    targetWattsSpan.textContent = targetWatts;
    await sendPowerTarget(targetWatts);
});

connectButton.addEventListener('click', async () => {
    try {
        statusText.textContent = "Status: Searching...";
        packetCount = 0;
        
        const device = await navigator.bluetooth.requestDevice({
            filters: [{
                services: [CYCLING_POWER_SERVICE]
            }],
            optionalServices: [CYCLING_POWER_SERVICE, WAHOO_TRAINER_SERVICE]
        });
        
        const deviceName = device.name || "KICKR Device";
        statusText.textContent = `Status: ${deviceName} Selected. Connecting...`;
        
        const server = await device.gatt.connect();
        statusText.textContent = "Status: Handshaking with Trainer...";
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const powerService = await server.getPrimaryService(CYCLING_POWER_SERVICE);
        const powerCharacteristic = await powerService.getCharacteristic(POWER_MEASUREMENT_CHAR);
        
        // Try to get trainer control
        try {
            statusText.textContent = "Status: Accessing trainer control...";
            const trainerService = await server.getPrimaryService(WAHOO_TRAINER_SERVICE);
            trainerCharacteristic = await trainerService.getCharacteristic(WAHOO_TRAINER_CHAR);
            
            controlStatus.textContent = "Control: Found trainer service";
            
            statusText.textContent = "Status: Unlocking trainer...";
            const unlockCmd = new Uint8Array([0x20, 0xEE, 0xFC]);
            await trainerCharacteristic.writeValue(unlockCmd);
            
            controlStatus.textContent = "Control: Unlocked successfully";
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await sendPowerTarget(targetWatts);
            
            statusText.textContent = "Status: Connected with control!";
        } catch (controlError) {
            statusText.textContent = "Status: Connected (read-only)";
            controlStatus.textContent = `Control: Unavailable - ${controlError.message}`;
            trainerCharacteristic = null;
        }
        
        await powerCharacteristic.startNotifications();
        
        powerCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            packetCount++;
            
            const flags = value.getUint8(0);
            const watts = value.getUint16(2, true);
            currentPowerDisplay.textContent = `Current: ${watts}`;
            
            // Log raw bytes
            const bytes = [];
            for (let i = 0; i < value.byteLength; i++) {
                bytes.push(value.getUint8(i).toString(16).padStart(2, '0'));
            }
            dataInfo.textContent = `Data packets: ${packetCount}, Length: ${value.byteLength} bytes, Raw: ${bytes.join(' ')}`;
            
            // Try to parse cadence from different positions
            let cadenceInfo = "Not found in packet";
            let bestCadence = null;
            
            if (value.byteLength >= 6) {
                const pos4 = value.getUint16(4, true);
                const pos6 = value.byteLength >= 8 ? value.getUint16(6, true) : null;
                
                cadenceInfo = `Position 4: ${pos4}`;
                if (pos6 !== null) {
                    cadenceInfo += `, Position 6: ${pos6}`;
                }
                
                // Pick most reasonable cadence value
                if (pos6 !== null && pos6 > 30 && pos6 < 150) {
                    bestCadence = pos6;
                } else if (pos4 > 30 && pos4 < 150) {
                    bestCadence = pos4;
                } else if (pos4 / 2 > 30 && pos4 / 2 < 150) {
                    bestCadence = Math.round(pos4 / 2);
                    cadenceInfo += ` (using halved value)`;
                }
            }
            
            cadenceDebug.textContent = `Cadence data: ${cadenceInfo}`;
            
            if (bestCadence) {
                cadenceDisplay.textContent = `Cadence (RPM): ${bestCadence}`;
            }
        });
        
        device.addEventListener('gattserverdisconnected', () => {
            statusText.textContent = "Status: Disconnected. Please scan again.";
            currentPowerDisplay.textContent = "Current: --";
            cadenceDisplay.textContent = "Cadence (RPM): --";
            controlStatus.textContent = "Control: Not connected";
            lastCommand.textContent = "Last command: None";
            dataInfo.textContent = "Data packets: 0";
            cadenceDebug.textContent = "Cadence data: Not available";
            trainerCharacteristic = null;
        });
        
    } catch (error) {
        statusText.textContent = "Status: Error - " + (error.message || "Unknown error");
        controlStatus.textContent = `Control: Connection failed - ${error.message}`;
    }
});
    </script>
</body>
</html>