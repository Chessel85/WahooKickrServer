<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadence Monitor</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #fff; color: #000; }
        button { 
            width: 100%; padding: 25px; font-size: 1.4rem; font-weight: bold;
            border: 2px solid #000; border-radius: 10px; background: #eee;
        }
        .display-area { margin-top: 40px; }
        #rpmDisplay { font-size: 5rem; font-weight: bold; display: block; }
        #status { margin-top: 20px; font-size: 1rem; color: #444; }
    </style>
</head>
<body>

    <button id="scanBtn">Connect Wahoo Sensor</button>

    <div class="display-area" role="main">
        <p>Current Cadence</p>
        <strong id="rpmDisplay" aria-live="polite">--</strong>
        <p>RPM</p>
    </div>

    <div id="status">Status: Ready</div>

    <script>
        let lastRevCount = -1;
        let lastEventTime = -1;
        const rpmDisplay = document.getElementById('rpmDisplay');
        const status = document.getElementById('status');

        document.getElementById('scanBtn').addEventListener('click', async () => {
            try {
                status.textContent = "Searching...";
                
                // Using the exact filter logic from the diagnostic script
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x1816] }]
                });

                const server = await device.gatt.connect();
                status.textContent = "Connected: " + device.name;

                const service = await server.getPrimaryService(0x1816);
                const characteristic = await service.getCharacteristic(0x2A5B);
                
                await characteristic.startNotifications();
                status.textContent = "Listening... Pedal now.";
                rpmDisplay.textContent = "0";

                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value;
                    
                    // Wahoo BlueSC (Flag 0x03) puts Cadence data at byte 7
                    const revCount = value.getUint16(7, true);
                    const eventTime = value.getUint16(9, true);

                    if (lastRevCount !== -1 && revCount !== lastRevCount) {
                        let revDiff = revCount - lastRevCount;
                        if (revDiff < 0) revDiff += 65536;

                        let timeDiff = eventTime - lastEventTime;
                        if (timeDiff < 0) timeDiff += 65536;

                        const timeInSeconds = timeDiff / 1024;
                        if (timeInSeconds > 0) {
                            const rpm = Math.round((revDiff / timeInSeconds) * 60);
                            rpmDisplay.textContent = rpm;
                        }
                    }
                    
                    lastRevCount = revCount;
                    lastEventTime = eventTime;
                });

            } catch (error) {
                status.textContent = "Error: " + error.message;
            }
        });
    </script>
</body>
</html>