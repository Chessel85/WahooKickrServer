<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadence Monitor</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; text-align: center; }
        #connectBtn { 
            width: 100%; padding: 25px; font-size: 1.4rem; font-weight: bold;
            border: 3px solid #000; border-radius: 15px; background: #e7f3ff;
        }
        #rpmDisplay { font-size: 6rem; font-weight: bold; display: block; margin: 20px 0; }
        #status { margin-top: 20px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <button id="connectBtn">Connect Sensor</button>

    <div role="main">
        <p>Current Cadence</p>
        <strong id="rpmDisplay" aria-live="polite">--</strong>
        <p>RPM</p>
    </div>

    <div id="status">Status: Ready. Tap button and select your Wahoo.</div>

    <script>
        let lastRevCount = -1;
        let lastEventTime = -1;

        const rpmDisplay = document.getElementById('rpmDisplay');
        const status = document.getElementById('status');

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                status.textContent = "Opening device list...";
                
                // Broad search: Accept all devices to ensure the Wahoo shows up
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0x1816] // We still need permission to talk to the cycling service
                });

                status.textContent = "Connecting to " + device.name + "...";
                const server = await device.gatt.connect();
                
                status.textContent = "Setting up Cadence...";
                const service = await server.getPrimaryService(0x1816);
                const char = await service.getCharacteristic(0x2A5B);
                
                await char.startNotifications();
                status.textContent = "Connected! Pedal to see RPM.";
                rpmDisplay.textContent = "0";

                char.addEventListener('characteristicvaluechanged', (event) => {
                    const data = event.target.value;
                    // Combo sensor (Flag 0x03) puts cadence at offset 7
                    const revCount = data.getUint16(7, true);
                    const eventTime = data.getUint16(9, true);

                    if (lastRevCount !== -1 && revCount !== lastRevCount) {
                        let revDiff = revCount - lastRevCount;
                        if (revDiff < 0) revDiff += 65536;

                        let timeDiff = eventTime - lastEventTime;
                        if (timeDiff < 0) timeDiff += 65536;

                        const timeInSeconds = timeDiff / 1024;
                        if (timeInSeconds > 0) {
                            const rpm = Math.round((revDiff / timeInSeconds) * 60);
                            rpmDisplay.textContent = rpm;
                        }
                    }
                    lastRevCount = revCount;
                    lastEventTime = eventTime;
                });
            } catch (e) {
                status.textContent = "Connection failed: " + e.message;
            }
        });
    </script>
</body>
</html>