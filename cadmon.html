<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadence Monitor</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 500px; margin: auto; text-align: center; }
        #connectBtn { 
            width: 100%; padding: 25px; font-size: 1.4rem; font-weight: bold;
            border: 3px solid #000; border-radius: 15px; background: #e7f3ff; margin-bottom: 30px;
        }
        .cadence-container { border: 4px solid #333; border-radius: 20px; padding: 40px 10px; }
        .label { font-size: 1.2rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        #rpmDisplay { font-size: 6rem; font-weight: bold; display: block; margin: 10px 0; }
        #status { margin-top: 20px; font-weight: bold; color: #444; }
    </style>
</head>
<body>

    <button id="connectBtn">Connect Cadence Sensor</button>

    <div class="cadence-container" role="main">
        <span class="label">Cadence</span>
        <strong id="rpmDisplay" aria-live="polite" aria-atomic="true">--</strong>
        <span class="label">RPM</span>
    </div>

    <div id="status">Status: Ready</div>

    <script>
        let lastRevCount = -1;
        let lastEventTime = -1;
        let lastAnnouncedRpm = 0;
        let lastAnnouncementTime = 0;

        const rpmDisplay = document.getElementById('rpmDisplay');
        const status = document.getElementById('status');

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                status.textContent = "Searching...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x1816] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0x1816);
                const char = await service.getCharacteristic(0x2A5B);
                
                await char.startNotifications();
                status.textContent = "Connected and Listening";
                rpmDisplay.textContent = "0";

                char.addEventListener('characteristicvaluechanged', handleCadence);
            } catch (e) {
                status.textContent = "Error: " + e.message;
            }
        });

        function handleCadence(event) {
            const data = event.target.value;
            
            /* Based on your RAW DATA (0x03 flag):
               Cumulative Revolutions are at offset 7 and 8 (Uint16)
               Last Event Time is at offset 9 and 10 (Uint16, 1/1024s units)
            */
            const revCount = data.getUint16(7, true);
            const eventTime = data.getUint16(9, true);

            if (lastRevCount === -1) {
                lastRevCount = revCount;
                lastEventTime = eventTime;
                return;
            }

            if (revCount !== lastRevCount) {
                let revDiff = revCount - lastRevCount;
                if (revDiff < 0) revDiff += 65536; // Handle 16-bit rollover

                let timeDiff = eventTime - lastEventTime;
                if (timeDiff < 0) timeDiff += 65536; // Handle 16-bit rollover

                // Convert 1/1024s units to seconds
                const timeInSeconds = timeDiff / 1024;

                if (timeInSeconds > 0) {
                    const rpm = Math.round((revDiff / timeInSeconds) * 60);
                    updateDisplay(rpm);
                }

                lastRevCount = revCount;
                lastEventTime = eventTime;
            }
        }

        function updateDisplay(rpm) {
            rpmDisplay.textContent = rpm;

            // Logic to prevent VoiceOver from being too annoying
            // It will speak if the RPM changes by more than 2, OR if 3 seconds have passed
            const now = Date.now();
            if (Math.abs(rpm - lastAnnouncedRpm) > 2 || (now - lastAnnouncementTime > 3000)) {
                // Changing the text content triggers the aria-live region
                lastAnnouncedRpm = rpm;
                lastAnnouncementTime = now;
            }
        }
    </script>
</body>
</html>