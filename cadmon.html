<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadence - Stephen Hawking</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; text-align: center; background: #fff; color: #000; }
        .version { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        #connectBtn { 
            width: 100%; padding: 25px; font-size: 1.4rem; font-weight: bold;
            border: 3px solid #000; border-radius: 15px; background: #f0f7ff; 
        }
        .display-card { border: 4px solid #000; border-radius: 20px; margin-top: 30px; padding: 40px 10px; }
        #rpmDisplay { font-size: 6rem; font-weight: bold; display: block; }
        .unit { font-size: 1.5rem; color: #444; font-weight: bold; }
        #status { margin-top: 20px; font-size: 1rem; color: #666; }
    </style>
</head>
<body>

    <div class="version">Version: Stephen Hawking</div>
    <button id="connectBtn">Connect Wahoo Sensor</button>

    <div class="display-card" role="main">
        <p class="unit">Cadence</p>
        <strong id="rpmDisplay" aria-live="polite">--</strong>
        <p class="unit">RPM</p>
    </div>

    <div id="status">Status: Ready.</div>

    <script>
        let lastRevCount = -1;
        let lastEventTime = -1;

        const rpmDisplay = document.getElementById('rpmDisplay');
        const status = document.getElementById('status');

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                status.textContent = "Connecting...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x1816] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0x1816);
                const char = await service.getCharacteristic(0x2A5B);
                
                await char.startNotifications();
                status.textContent = "Connected. Reading data...";
                rpmDisplay.textContent = "0";

                char.addEventListener('characteristicvaluechanged', (event) => {
                    const data = event.target.value;
                    
                    // Byte 1: Cumulative Crank Revolutions (Uint16)
                    // Byte 3: Last Crank Event Time (Uint16)
                    const revCount = data.getUint16(1, true);
                    const eventTime = data.getUint16(3, true);

                    // If this is the very first packet, just save the values and wait for the next one
                    if (lastRevCount === -1) {
                        lastRevCount = revCount;
                        lastEventTime = eventTime;
                        status.textContent = "Initial sync... Keep pedaling.";
                        return;
                    }

                    // If the revolution count has changed, we calculate RPM
                    if (revCount !== lastRevCount) {
                        let revDiff = (revCount - lastRevCount + 65536) % 65536;
                        let timeDiff = (eventTime - lastEventTime + 65536) % 65536;

                        if (timeDiff > 0) {
                            // 1024 is the standard Bluetooth frequency for these sensors
                            const rpm = Math.round((revDiff * 60 * 1024) / timeDiff);
                            rpmDisplay.textContent = rpm;
                            status.textContent = "Receiving Data";
                        }
                        
                        lastRevCount = revCount;
                        lastEventTime = eventTime;
                    }
                });
            } catch (e) {
                status.textContent = "Error: " + e.message;
            }
        });
    </script>
</body>
</html>